# =============================================================================
# NGINX RATE LIMITING CONFIGURATION
# =============================================================================
# This file defines rate limiting rules for different categories of bots
# 
# Bot Categories:
# - Undesirable Bots: Completely blocked with 444 connection closed

# - AI Bots: Rate limited to 1 req/min (ClaudeBot, GPTBot, etc.)
# - Suspicious Tools: Rate limited to 2 req/s (Playwright, PythonRequests, etc.)
# - Search Engine Bots: Rate limited to 3 req/s (Googlebot, Bingbot, etc.)
# - Social Media Bots: Rate limited to 5 req/s (Facebook, Twitter, etc.)
# - Other Legitimate Bots: Rate limited to 10 req/s (monitoring, feeds, etc.)
# - General Traffic: Rate limited to 30 req/s
#
# Last updated: June 2025
#
# Recent improvements:
# - Enhanced AI bot detection (added Google-Extended, Meta-ExternalAgent, etc.)
# - Expanded security scanner blocking (Acunetix, Burp, OpenVAS, etc.)
# - Added more SEO/marketing crawlers to undesirable list
# - Improved social media bot coverage with case variations
# - Added headless browser detection (Playwright, Puppeteer, Selenium)
# - Refined scraper detection patterns
# - Created "suspicious tools" category for rate-limiting instead of blocking
# - Added comprehensive rate limiting logging for monitoring and analysis

# -----------------------------------------------------------------------------
# BOT CATEGORIZATION
# -----------------------------------------------------------------------------

# Undesirable bots - block completely (444 connection closed)
map $http_user_agent $is_undesirable_bot {
    default 0;
    ~*Acunetix 1;
    ~*AhrefsBot 1;
    ~*AwarioBot 1;
    ~*AwarioSmartBot 1;
    ~*BLEXBot 1;
    ~*BacklinkCrawler 1;
    ~*BrandVerity 1;
    ~*Burp 1;
    ~*Cincraw 1;
    ~*CompSpyBot 1;
    ~*DataForSeoBot 1;
    ~*DirBuster 1;
    ~*DotBot 1;
    ~*FAST-WebCrawler 1;
    ~*Gobuster 1;
    ~*HTTrack 1;
    ~*LinkpadBot 1;
    ~*MJ12bot 1;
    ~*Mediatoolkitbot 1;
    ~*MegaIndex 1;
    ~*MetaJobBot 1;
    ~*Nessus 1;
    ~*NetSparker 1;
    ~*Nikto 1;
    ~*Nmap 1;
    ~*OpenVAS 1;
    ~*PetalBot 1;
    ~*Qwantify 1;
    ~*Scrapy 1;
    ~*ScrapyBot 1;
    ~*SeekportBot 1;
    ~*SemrushBot 1;
    ~*SentiBot 1;
    ~*SiteAuditBot 1;
    ~*SiteSnagger 1;
    ~*WebCopier 1;
    ~*WebDataExtractor 1;
    ~*WinHTTrack 1;
    ~*YandexImages 1;
    ~*YandexNews 1;
    ~*ZAP 1;
    ~*ZoominfoBot 1;
    ~*coccocbot-image 1;
    ~*coccocbot-web 1;
    ~*masscan 1;
    ~*nuclei 1;
    ~*rogerbot 1;
    ~*skipfish 1;
    ~*spbot 1;
    ~*sqlmap 1;
    ~*startmebot 1;
    ~*test-bot 1;
    ~*trendictionbot 1;
    ~*w3af 1;
    ~*wpscan 1;
    ~*zmap 1;
}

# AI bots - rate limit very strictly (1r/m)
map $http_user_agent $is_ai_bot {
    default 0;
    ~*AI2Bot 1;
    ~*Anthropic-Claude 1;
    ~*Bard 1;
    ~*ByteDance 1;
    ~*Character\.ai 1;
    ~*ChatGPT-User 1;
    ~*Claude 1;
    ~*Claude-Web 1;
    ~*ClaudeBot 1;
    ~*Cohere 1;
    ~*Copilot 1;
    ~*FacebookBot 1;
    ~*GPTBot 1;
    ~*Gemini 1;
    ~*Google-Extended 1;
    ~*Meta-AI 1;
    ~*Meta-ExternalAgent 1;
    ~*OAI-SearchBot 1;
    ~*OpenAI 1;
    ~*Perplexity 1;
    ~*PerplexityBot 1;
    ~*SearchGPT 1;
    ~*TikTok 1;
    ~*YouBot 1;
    ~*anthropic-ai 1;
    ~*openai 1;
    ~*thesis-research-bot 1;
}

# Suspicious but potentially legitimate tools - rate limit strictly
map $http_user_agent $is_suspicious_tool {
    default 0;
    ~*HeadlessChrome 1;
    ~*PhantomJS 1;
    ~*Playwright 1;
    ~*Puppeteer 1;
    ~*PythonRequests 1;
    ~*Selenium 1;
    ~*libwww 1;
    ~*python-requests 1;
    ~*python-urllib 1;
}

# Search engine bots - rate limit moderately (legitimate indexing)
map $http_user_agent $is_search_engine_bot {
    default 0;
    ~*Amazonbot 1;          # Amazon crawler (moved from undesirable)
    ~*Applebot 1;           # Apple Siri/Spotlight (moved from undesirable)
    ~*CCBot 1;              # Common Crawl
    ~*DuckDuckBot 1;        # DuckDuckGo
    ~*Googlebot 1;          # Google main crawler
    ~*Googlebot-Image 1;    # Google image crawler
    ~*Googlebot-Video 1;    # Google video crawler
    ~*SeznamBot 1;          # Czech search engine
    ~*baiduspider 1;        # Baidu
    ~*bingbot 1;            # Microsoft Bing
    ~*exabot 1;             # Exalead
    ~*facebookbot 1;        # Facebook's crawler
    ~*ia_archiver 1;        # Internet Archive
    ~*msnbot 1;             # Microsoft legacy bot
    ~*slurp 1;              # Yahoo
    ~*sogou 1;              # Chinese search engine
    ~*yandexbot 1;          # Yandex general bot
}

# Social media bots - rate limit moderately (medium request volume)
map $http_user_agent $is_social_media_bot {
    default 0;
    ~*BlueSky 1;
    ~*Discord 1;
    ~*Facebot 1;
    ~*Instagram 1;
    ~*LinkedInBot 1;
    ~*Mastodon 1;
    ~*Pinterest 1;
    ~*Reddit 1;
    ~*Slack 1;
    ~*Snapchat 1;
    ~*Telegram 1;
    ~*Threads 1;
    ~*TikTokBot 1;
    ~*Tumblr 1;
    ~*Twitterbot 1;
    ~*WhatsApp 1;
    ~*bluesky 1;
    ~*discordbot 1;
    ~*facebookexternalhit 1;
    ~*instagrambot 1;
    ~*linkedinbot 1;
    ~*mastodonbot 1;
    ~*pinterest 1;
    ~*redditbot 1;
    ~*slackbot 1;
    ~*snapchat 1;
    ~*telegrambot 1;
    ~*threads 1;
    ~*tiktokbot 1;
    ~*tumblr 1;
    ~*twitterbot 1;
    ~*whatsapp 1;
}

# Other legitimate bots - rate limit lightly (low request volume)
map $http_user_agent $is_other_legitimate_bot {
    default 0;
    ~*crazyegg 1;
    ~*datadoghq 1;
    ~*deadlinkchecker 1;
    ~*embedly 1;            # Embed service
    ~*feedfetcher 1;        # Google Feed Fetcher
    ~*fullstory 1;
    ~*grafana 1;
    ~*gtmetrix 1;
    ~*hotjar 1;
    ~*jetpack 1;
    ~*lighthouse 1;
    ~*logrocket 1;
    ~*nagios 1;
    ~*newrelic 1;
    ~*pagespeed 1;
    ~*pingdom 1;
    ~*prometheus 1;
    ~*sentry 1;
    ~*statuspage 1;
    ~*uptimerobot 1;
    ~*w3c_validator 1;
    ~*webpagetest 1;
    ~*wordpress 1;
    ~*zabbix 1;
}

# -----------------------------------------------------------------------------
# RATE LIMITING KEYS
# -----------------------------------------------------------------------------
# These maps create conditional keys for rate limiting based on bot category

# Key for search engine bots
map $is_search_engine_bot $search_engine_limit_key {
    0 "";
    1 $http_cf_connecting_ip;
}

# Key for social media bots
map $is_social_media_bot $social_media_limit_key {
    0 "";
    1 $http_cf_connecting_ip;
}

# Key for AI bots
map $is_ai_bot $ai_bot_limit_key {
    0 "";
    1 $http_cf_connecting_ip;
}

# Key for suspicious tools
map $is_suspicious_tool $suspicious_tool_limit_key {
    0 "";
    1 $http_cf_connecting_ip;
}

# Key for other legitimate bots
map $is_other_legitimate_bot $other_legitimate_limit_key {
    0 "";
    1 $http_cf_connecting_ip;
}

# -----------------------------------------------------------------------------
# RATE LIMITING ZONES
# -----------------------------------------------------------------------------
# Define rate limiting zones with different thresholds for each bot category

# AI bots - very strict limits (1r/m)
limit_req_zone $ai_bot_limit_key zone=ai_bots:5m rate=1r/m;

# Suspicious tools - strict limits (2r/s) - allows legitimate use but prevents abuse
limit_req_zone $suspicious_tool_limit_key zone=suspicious_tools:5m rate=2r/s;

# Search engines - moderate limits (3r/s) - increased for better SEO
limit_req_zone $search_engine_limit_key zone=search_engines:10m rate=3r/s;

# Social media - moderate limits (5r/s)
limit_req_zone $social_media_limit_key zone=social_media:5m rate=5r/s;

# Other legitimate bots - light limits (10r/s)
limit_req_zone $other_legitimate_limit_key zone=other_bots:5m rate=10r/s;

# -----------------------------------------------------------------------------
# GENERAL PROTECTION
# -----------------------------------------------------------------------------
# General rate limiting for all clients to prevent DoS attacks
limit_req_zone $http_cf_connecting_ip zone=general:10m rate=60r/s;

# Login-specific rate limiting - strict protection for authentication endpoints
limit_req_zone $http_cf_connecting_ip zone=login:10m rate=5r/m;

# -----------------------------------------------------------------------------
# STATUS CODES
# -----------------------------------------------------------------------------
# Define custom error response for rate limited requests
limit_req_status 429; # Too Many Requests
