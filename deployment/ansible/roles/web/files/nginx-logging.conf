# ANSIBLE MANAGED FILE - JSON Logging Configuration
log_format json_enhanced escape=json '{'
    '"timestamp":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"cf_connecting_ip":"$http_cf_connecting_ip",'
    '"remote_user":"$remote_user",'
    '"request_method":"$request_method",'
    '"request_uri":"$request_uri",'
    '"server_protocol":"$server_protocol",'
    '"status":"$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"upstream_response_time":"$upstream_response_time",'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"http_referer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"http_x_forwarded_for":"$http_x_forwarded_for",'
    '"http_cf_ray":"$http_cf_ray",'
    '"http_cf_ipcountry":"$http_cf_ipcountry",'
    '"ssl_protocol":"$ssl_protocol",'
    '"ssl_cipher":"$ssl_cipher",'
    '"request_length":"$request_length",'
    '"connection_requests":"$connection_requests",'
    '"args":"$args"'
'}';

# Use JSON logging format
access_log /var/log/nginx/access.log json_enhanced;

# $request_time (measures end-to-end latency from the client's perspective -- useful for identifying slow requests due to network issues, large payloads, or NGINX itself)
# The total time taken to process a client request, from the moment NGINX receives the first byte of the request
# until it finishes sending the last byte of the response back to the client.
# WHAT IT INCLUDES:
# Time spent reading the client's request headers/body
# Time spent proxying the request to gunicorn
# Time spent generating a response (e.g., serving static files or processing FastCGI)
# Time spent sending the response back to the client


# $upstream_response_time (identifies backend performance bottlenecks. If this value is high, gunicorn is slow)
# The time NGINX spends waiting for a response from gunicorn.
# This is only relevant when NGINX acts as a reverse proxy.
# WHAT IT INCLUDES:
# Time to establish a connection with the upstream server
# Time for the upstream server to process the request
# Time to receive the full response from the upstream server

# WHAT IT EXCLUDES:
# Time spent sending the response back to the client
# Time spent on NGINXâ€™s internal processing (e.g., SSL termination, gzip compression)

# Static Files: For requests served directly by NGINX (no proxying), $upstream_response_time is empty or -