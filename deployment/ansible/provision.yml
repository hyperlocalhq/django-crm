---
# Django CRM Full Server Provisioning Playbook
# Usage: ansible-playbook -i inventories/staging/hosts.yml django_crm_provision.yml

- name: Provision Django CRM Server
  hosts: webservers
  gather_facts: yes

  # Safety check: Ensure we're only running against one host at a time
  pre_tasks:
    - name: Verify single host deployment
      fail:
        msg: "This playbook must be run against a single host. Found {{ ansible_play_hosts | length }} hosts."
      when: ansible_play_hosts | length > 1
      run_once: true

    - name: Load Django CRM variables
      include_vars:
        file: vars/django_crm_vars.yml

  roles:
    - common
    - security
    - database
    - python
    - web

  # Django CRM app deployment uses custom tasks
  tasks:
    - name: Include Django CRM app tasks
      include_tasks: roles/app/tasks/django_crm.yml
      tags: [app, deploy]
